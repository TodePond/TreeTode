 <script src="https://deno.land/x/habitat/build/habitat-embed.js"></script>
<script src="https://deno.land/x/mothertode/build/mothertode-embed.js"></script>
<script>

Habitat.install(window)
MotherTode.install(window)

const LispTode = (source, argData) => {
	const result = Term.args(LispToder, (args) => ({...args, ...argData}))(source)
	if (result.success) return result.output
	return result
}

const resetGlobals = () => {
	Term.resetCache()
	LispToder.Global.terms = []
LispTode(`(define lambda {{ (args, body, b) => {
	return ("{{ (" + args.join(", ") + ") => LispTode('(" + body.join(" ") + ")', {" + args.join(", ") + "})}"+"}")
} }})`)
}
	
const LispToder = MotherTode(`

	++ Sanitise
	REST :: /[^]/+ | EOF
	WhiteSpace :: " " | "\n" | "	"
	Sanitise <
		:: "{{" SanitiseJavaScriptRest SanitiseJavaScriptEnd
		:: "(" WhiteSpace+ ")" >> ([open, inner, close]) => open + close
		:: ")" WhiteSpace+ "(" >> ([close, inner, open]) => close + " " + open
		:: /[^()]/ WhiteSpace* "(" >> ([c, ws, open]) => c + " " + open
		:: ")" WhiteSpace* /[^()]/ >> ([close, gap, c]) => close + " " + c
		:: "(" WhiteSpace+ >> "("
		:: WhiteSpace+ EOF >> ""
		:: WhiteSpace+ ")" >> ")"
		:: WhiteSpace+ >> " "
		:: /[^]/
	>*
	
	SanitiseJavaScriptRest :: "}}" | (/[^]/ SanitiseJavaScriptRest)
	SanitiseJavaScriptEnd <
		:: WhiteSpace+ ")" >> ")"
		:: WhiteSpace+ >> " "
		>> ""
	>

	:: {WhiteSpace} Value EOF
	>> ([ws, value]) => value.output

	Value :: Quote | Call | Function | Variable | JavaScript | Atom | Definition | List
	Values :: Value {" " Value}
	Atom :: /[^() \n	]/+
	List <
		++ "(" Function REST :: Value
		++ "(" Call REST :: Value
		++ "(" Variable REST :: Value
		:: "(" Values? ")"
	>
	QuotedList :: "(" [Atom {" " Atom}] ")"
	Quote :: "'" [" "] < JavaScript Atom QuotedList > >> ([open, gap, value]) => value.output
	Function ++ "(" Global | Local " " REST :: Value
	Variable ++ Global | Local (<" " ")"> REST) | EOF :: Value
	Global <
		?? false
	>

	Local (
		:: Atom
		?? (atom) => (atom.args.hasOwnProperty(atom.output))
		>> (atom) => (atom.args[atom.output])
	)

	Definition :: "(define " Value " " Value ")" >> (result) => {
		const [define, name, gap, value] = result
		const mt = ':: "' + name + '"' + " >> \`" + value + "\`"
		LispToder.Global.terms.unshift(MotherTode(mt))
		return result.output
	}

	JavaScript :: "{{" JavaScriptRest
	JavaScriptRest :: "}}" | (/[^]/ JavaScriptRest)
	Call ++ Apply REST :: Value
	Apply :: "(" JavaScript " " Arguments ")" >> ([open, js, gap, args]) => {
		const inner = js.output.slice(2, -2)
		const func = new Function("return " + inner)()
		const argsArray = new Function("return " + args.output)()
		const result = func(...argsArray).toString()
		return result
	}

	Arguments :: Argument {ArgumentsTail} >> (args) => '[' + args + ']'
	ArgumentsTail :: " " Argument >> ([gap, arg]) => ", " + arg
	Argument ++ Value REST :: <
		:: JavaScript >> (js) => "\`" + js.output.slice(2, -2).trim() + "\`"
		:: ArgumentAtom
		:: "(" ArgumentAtoms? ")" >> ([open, inner, close]) => '[' + inner + ']'
	>
	ArgumentAtom :: Atom >> (atom) => '"' + atom + '"'
	ArgumentAtoms :: ArgumentAtom {ArgumentAtomsTail}
	ArgumentAtomsTail :: " " ArgumentAtom >> ([gap, atom]) => ", " + atom
	
`)

LispTode("27".d).d
"".d
LispTode("(Hello world!)".d).d
"".d
LispTode("(2 (3 (4 5) 6))".d).d
"".d
LispTode("(my 'name is name)".d).d
"".d
LispTode("(define age 27)".d).d
"".d
LispTode("(I am age years old)".d).d
"".d
LispTode("(define scores (3 2 5))".d).d
"".d
LispTode("(my 'scores are scores)".d).d
"".d
LispTode("(define team (Bob Luke Kevin))".d).d
"".d
LispTode("team".d).d
"".d
LispTode("(define 'name Luke)".d).d
"".d
LispTode('{{ () => "(Hello world!)" }}'.d).d
"".d
LispTode('({{ () => "(Hello world!)" }} ())'.d).d
"".d
LispTode('(define greet {{ (name) => "(Hello " + name + "!)" }})'.d).d
"".d
LispTode('({{ (name) => "(Hello " + name + "!)" }} Bob)'.d).d
"".d
LispTode("(greet Bob)".d).d
"".d
LispTode('(define add {{ (a, b) => parseInt(a) + parseInt(b) }})'.d).d
"".d
LispTode('(add 3 2)'.d).d
"".d
LispTode(`(define lambda {{ (args, body, b) => {
	return ("{{ (" + args.join(", ") + ") => LispTode('(" + body.join(" ") + ")', {" + args.join(", ") + "})}"+"}")
} }})`.d).d
"".d
//LispTode(`((lambda (a b) {{ parseInt(a) - parseInt(b) }}) 5 2)`.d).da
//"".d
LispTode(`(define addOne (lambda (a) '(add a 1)))`.d).d
"".d
LispTode(`(addOne 3)`.d).d
"".d
LispTode(`(define + (lambda (a b) '(add a b)))`.d).d
"".d
LispTode(`(+ 3 2)`.d).d
"".d

print("WELCOME TO LISPTODE!!!")
print("You can try it out by using the LispTode function!")
print("For example...")
print('%cLispTode("(+ 3 2)")', "color: blue")
print('%cLispTode("(Hello world!)")', "color: blue")
print('%cLispTode("((lambda (x) \'(+ x 2)) 5)")', "color: blue")
print('%cLispTode("(define score 20)")', "color: blue")
print('%cLispTode("(define double (lambda (x) \'(+ x x)))")', "color: blue")
print("")
print("By the way, you can reset the globals by using this function:")
print('%cresetGlobals()', "color: blue")
print("")

</script>
